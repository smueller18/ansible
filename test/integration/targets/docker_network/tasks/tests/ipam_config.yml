---
- name: Registering network names
  set_fact:
    nname_ipam_1: "{{ name_prefix ~ '-network-ipam-1' }}"
    nname_ipam_2: "{{ name_prefix ~ '-network-ipam-2' }}"
    nname_ipam_3: "{{ name_prefix ~ '-network-ipam-3' }}"

- name: Registering network names
  set_fact:
    dnetworks: "{{ dnetworks }} + [nname_ipam_1, nname_ipam_2, nname_ipam_3]"


#################### network-ipam-1 ####################
- name: Create network with custom IPAM config
  docker_network:
    name: "{{ nname_ipam_1 }}"
    ipam_config:
      - subnet: 172.3.27.0/24
        gateway: 172.3.27.1
        iprange: 192.168.1.0/24
  register: network

- assert:
    that:
      - network is changed

- name: Change subnet, gateway and iprange of network with custom IPAM config
  docker_network:
    name: "{{ nname_ipam_1 }}"
    ipam_config:
      - subnet: 172.3.28.0/24
        gateway: 172.3.28.1
        iprange: 192.168.2.0/24
  register: network
  diff: yes

- assert:
    that:
      - network is changed
      - network['diff'] | length == 3
      - '"ipam_config[0].subnet" in network["diff"]'
      - '"ipam_config[0].gateway" in network["diff"]'
      - '"ipam_config[0].iprange" in network["diff"]'

- name: Remove gateway and iprange of network with custom IPAM config
  docker_network:
    name: "{{ nname_ipam_1 }}"
    ipam_config:
      - subnet: 172.3.28.0/24
  register: network

- assert:
    that:
      - network is not changed


#################### network-ipam-2 ####################

- name: Create network with ipv6 IPAM config
  docker_network:
    name: "{{ nname_ipam_2 }}"
    enable_ipv6: yes
    ipam_config:
      - subnet: fdd1:ac8c:0557:7ce0::/64
  register: network

- assert:
    that:
      - network is changed

- name: Change subnet of network with ipv6 IPAM config
  docker_network:
    name: "{{ nname_ipam_2 }}"
    enable_ipv6: yes
    ipam_config:
      - subnet: fdd1:ac8c:0557:7ce1::/64
  register: network
  diff: yes

- assert:
    that:
      - network is changed
      - network['diff'] | length == 1
      - network['diff'][0] == "ipam_config[0].subnet"


#################### network-ipam-3 ####################

- name: Create network with ipv6 and custom ipv4 IPAM config
  docker_network:
    name: "{{ nname_ipam_3 }}"
    enable_ipv6: yes
    ipam_config:
      - subnet: 172.4.27.0/24
      - subnet: fdd1:ac8c:0557:7ce2::/64
  register: network

- assert:
    that:
      - network is changed

- name: Change subnet order of network with ipv6 and custom ipv4 IPAM config
  docker_network:
    name: "{{ nname_ipam_3 }}"
    enable_ipv6: yes
    ipam_config:
      - subnet: fdd1:ac8c:0557:7ce2::/64
      - subnet: 172.4.27.0/24
  register: network

- assert:
    that:
      - network is not changed

- name: Remove ipv6 from network with custom ipv4 and ipv6 IPAM config
  docker_network:
    name: "{{ nname_ipam_3 }}"
    enable_ipv6: no
    ipam_config:
      - subnet: 172.4.27.0/24
  register: network
  diff: yes

- assert:
    that:
      - network is changed
      - network['diff'] | length == 1
      - network['diff'][0] == "enable_ipv6"
